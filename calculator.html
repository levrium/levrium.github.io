<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>计算器</title>
        <style type="text/css">
html, body {
    font: 20px "Helvetica Neue", Helvetica, Arial, sans-serif;
}
header {
    font-size: 32px;
    line-height: 48px;
    font-weight: bold;
}
input {
    padding: 2px 3px;
    border: 2px solid #B0B0B0;
    border-radius: 4px;
    font-size: 18px;
}
input[type="button"] {
    background-color: #EFEFEF;
}
input[type="button"]:hover {
    background-color: #FFFFFF;
}
textarea {
    width: 75%;
    height: 5em;
    padding: 4px;
    border: 2px solid #B0B0B0;
    border-radius: 4px;
    margin: 8px 0px;
    display: block;
    font-family: Arial, sans-serif;
    font-size: 18px;
}
#factorization input[type="text"] {
    width: 75%;
}
#base-conversion .base {
    width: 60px;
    text-align: right;
}
#base-conversion .number {
    width: 30%;
    text-align: right;
}
#base-conversion .sequence {
    width: 45%;
    font-size: 14px;
    line-height: 21px;
}
#swap {
    width: 40px;
}
#monadic-equation input[type="text"] {
    width: 75%;
    margin: 8px 0px;
    display: block;
}
        </style>
        <script type="text/javascript">
class Factorization {
    constructor() {
        var button = document.querySelector('#factorization input[type="button"]');
        var input = document.querySelector('#factorization input[type="text"]');
        button.onclick = () => {
            if (input.value === "") {
                return;
            }
            try {
                var n = BigInt(input.value);
                if (n < 0n) {
                    throw RangeError;
                }
                this.factorize(n);
            }
            catch {
                alert("无效的数字");
            }
        };
    }
    factorize(n) {
        function sqrt(n) {
            if (n <= Number.MAX_SAFE_INTEGER) {
                return BigInt(~~(Number(n) ** 0.5));
            }
            var array = String(n).split("").map(Number);
            if (array.length % 2 === 1) {
                array.unshift(0);
            }
            var length = array.length / 2;
            var remainder = 0n;
            var result = [];
            for (let i = 0; i < length; i++) {
                remainder = remainder * 100n + BigInt(array.shift()) * 10n + BigInt(array.shift());
                let a = BigInt(result.join("")) * 20n;
                let j = 0n;
                for (; j < 10n && j * (a + j) <= remainder; j++) {}
                result.push(--j);
                remainder -= j * (a + j);
            }
            return BigInt(result.join(""));
        }
        function* Calc(n) {
            if (n === 0n || n === 1n) {
                return [n];
            }
            var factors = {};
            while (n % 2n === 0n) {
                factors[2n] = (factors[2n] || 0) + 1;
                n /= 2n;
            }
            while (n % 3n === 0n) {
                factors[3n] = (factors[3n] || 0) + 1;
                n /= 3n;
            }
            var limit = sqrt(n);
            for (let i = 5n; i <= limit; ) {
                while (n % i === 0n) {
                    factors[i] = (factors[i] || 0) + 1;
                    n /= i;
                    limit = sqrt(n);
                }
                i += 2n;
                while (n % i === 0n) {
                    factors[i] = (factors[i] || 0) + 1;
                    n /= i;
                    limit = sqrt(n);
                }
                i += 4n;
                yield [factors, n, i, limit];
            }
            if (n > 1n) {
                factors[n] = (factors[n] || 0) + 1;
            }
            return [factors, 1n, limit, limit];
        }
        var button = document.querySelector('#factorization input[type="button"]');
        var output = document.querySelectorAll('#factorization input[type="text"]')[1];
        var textProgress = document.querySelector("#factorization span");
        button.disabled = "true";
        textProgress.style.display = "inline";
        var calc = Calc(n);
        function loop() {
            var result = calc.next();
            for (let i = 0; i < 65536 && !result.done; i++) {
                result = calc.next();
            }
            var factors = {...result.value[0]};
            if (result.value[1] > 1n) {
                factors[result.value[1]] = (factors[result.value[1]] || 0) + 1;
            }
            var list = Object.keys(factors);
            list = list.map(item => factors[item] > 1 ? `${item}^${factors[item]}` : item);
            output.value = `${n} = ${list.join(" × ")}`;
            var progress = String(result.value[2] * 1000000n / result.value[3]);
            while (progress.length < 5) {
                progress = "0" + progress;
            }
            progress = progress.split("");
            progress.splice(-4, 0, ".");
            progress = progress.join("");
            textProgress.innerText = `${progress}% (${result.value[2]} / ${result.value[3]})`;
            if (result.done) {
                button.disabled = "";
                textProgress.style.display = "none";
            }
            else {
                setTimeout(loop, 1);
            }
        }
        loop();
    }
}
class BaseConversion {
    constructor() {
        document.querySelectorAll("#base-conversion .base").forEach((e, i) => e.oninput = () => {
            var base = Number(document.querySelectorAll("#base-conversion .base")[i].value);
            var sequence = document.querySelectorAll("#base-conversion .sequence")[i];
            if (!isNaN(base) && base >= 2 && base <= 256 && base % 1 === 0) {
                sequence.value = this.getText(base);
            }
            this.main();
        }, this);
        document.querySelector("#base-conversion .number").oninput = () => this.main();
        document.querySelectorAll("#base-conversion .sequence").forEach(e => e.oninput = () => this.main());
        document.querySelector("#swap").onclick = () => this.swap();
    }
    plus(a, b, base) {
        if (a.length < b.length) {
            [a, b] = [b, a];
        }
        var c = 0;
        for (let i = a.length - 1; i >= 0; i--) {
            let d = i < a.length - b.length ? 0 : b[i - a.length + b.length];
            a[i] += c + d;
            c = ~~(a[i] / base);
            a[i] %= base;
        }
        if (c > 0) {
            a.unshift(c);
        }
        return a;
    }
    multiple(a, b, base) {
        var r = [];
        for (let j = 0; j < b.length; j++) {
            for (let i = 0; i < a.length; i++) {
                r.push([a[i] * b[j]].concat(new Array(a.length + b.length - i - j - 2).fill(0)));
            }
        }
        var result = [];
        for (let i = 0; i < r.length; i++) {
            result = this.plus(result, r[i], base);
        }
        return result;
    }
    power(a, b, base) {
        var result = a;
        if (b === 0) {
            return [1];
        }
        for (let i = 1; i < b; i++) {
            result = this.multiple(result, a, base);
        }
        return result;
    }
    getText(base) {
        var text = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz+/ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſ";
        switch (base) {
            case 26 :
                return "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            case 32 :
                return "0123456789ABCDEFGHJKMNPQRSTVWXYZ";
            case 52 :
                return "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
            case 58 :
                return "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";
            default :
                return text.slice(0, base);
        }
    }
    swap() {
        var inputBase = document.querySelectorAll("#base-conversion .base");
        var inputNumber = document.querySelectorAll("#base-conversion .number");
        var inputSequence = document.querySelectorAll("#base-conversion .sequence");
        var base = inputBase[0].value;
        var sequence = inputSequence[0].value;
        inputBase[0].value = inputBase[1].value;
        inputBase[1].value = base;
        inputNumber[0].value = inputNumber[1].value;
        inputSequence[0].value = inputSequence[1].value;
        inputSequence[1].value = sequence;
        this.main();
    }
    main() {
        var base1 = Number(document.querySelectorAll("#base-conversion .base")[0].value);
        var num1 = document.querySelectorAll("#base-conversion .number")[0].value;
        var text1 = document.querySelectorAll("#base-conversion .sequence")[0].value;
        var base2 = Number(document.querySelectorAll("#base-conversion .base")[1].value);
        var inputNumber = document.querySelectorAll("#base-conversion .number")[1];
        var text2 = document.querySelectorAll("#base-conversion .sequence")[1].value;
        var error = document.querySelector("#base-conversion .error");
        error.innerText = "";
        if (isNaN(base1) || base1 < 2 || base1 > 256 || base1 % 1 !== 0) {
            error.innerText = "无效的初始进制";
            return;
        }
        if (!num1) {
            error.innerText = "初始数字为空";
            return;
        }
        if (text1.length !== base1) {
            error.innerText = "无效的初始序列";
            return;
        }
        if (isNaN(base2) || base2 < 2 || base2 > 256 || base2 % 1 !== 0) {
            error.innerText = "无效的目标进制";
            return;
        }
        if (text2.length !== base2) {
            error.innerText = "无效的目标序列";
            return;
        }
        if (!/[a-z]/.test(text1)) {
            num1 = num1.toUpperCase();
        }
        if (!/[A-Z]/.test(text1)) {
            num1 = num1.toLowerCase();
        }
        var n = [];
        for (let i = 0; i < num1.length; i++) {
            let d = text1.indexOf(num1.charAt(i));
            if (d === -1) {
                error.innerText = "初始数字中有未定义的位";
                return;
            }
            else {
                n.push(d);
            }
        }
        var result = [];
        for (let i = 0; i < n.length; i++) {
            result = this.plus(result, this.multiple([n[i]], this.power([base1], n.length - i - 1, base2), base2), base2);
        }
        while (result.length > 1 && result[0] === 0) {
            result.shift();
        }
        for (let i = 0; i < result.length; i++) {
            result[i] = text2.charAt(result[i]);
        }
        inputNumber.value = result.join("");
    }
}

class MonadicEquation {
    constructor() {
        var button = document.querySelector("#monadic-equation input");
        var input = document.querySelectorAll("#monadic-equation input")[1];
        var output = document.querySelector("#monadic-equation textarea");
        button.onclick = () => {
            if (input.value === "") {
                return;
            }
            var params = input.value.split(" ").filter(a => a).map(Number);
            if (params.includes(NaN)) {
                alert("参数错误");
                return;
            }
            while (params[0] === 0) {
                params.shift();
            }
            if (params.length <= 1) {
                alert("参数过少");
            }
            else {
                var result;
                switch (params.length) {
                    case 2 :
                        result = this.solveLinear(...params);
                        break;
                    case 3 :
                        result = this.solveQuadratic(...params);
                        break;
                    case 4 :
                        result = this.solveCubic(...params);
                        break;
                    case 5 :
                        result = this.solveQuartic(...params);
                        break;
                    default :
                        alert("不支持解该方程");
                        return;
                }
                result = result.map(item => {
                    if (typeof item === "object") {
                        return item[1] > 0 ? `${item[0]} + ${item[1]} i` : item[1] < 0 ? `${item[0]} - ${-item[1]} i` : item[0];
                    }
                    else {
                        return item;
                    }
                });
                output.value = result.map((item, i) => `x_${i + 1} = ${item}`).join("\n");
            }
        };
    }
    solveLinear(a, b) {
        return [-b / a];
    }
    solveQuadratic(a, b, c) {
        var Δ = b ** 2 - 4 * a * c;
        let m = -b / (2 * a);
        let n = Math.abs(Δ) ** 0.5 / (2 * a);
        return Δ >= 0 ? [m + n, m - n] : [[m, n], [m, -n]];
    }
    solveCubic(a, b, c, d) { // Fan Shengjin's formula
        var A = b ** 2 - 3 * a * c;
        var B = b * c - 9 * a * d;
        var C = c ** 2 - 3 * b * d;
        var Δ = B ** 2 - 4 * A * C;
        if (A === 0 && B === 0) {
            let x = -b / (3 * a);
            return [x, x, x];
        }
        else if (Δ === 0) {
            let k = B / A;
            let x = -k / 2;
            return [k - b / a, x, x];
        }
        else if (Δ > 0) {
            let root = (a, b) => a >= 0 ? a ** (1 / b) : -((-a) ** (1 / b));
            let y = A * b + 1.5 * a * (-B + Δ ** 0.5);
            let z = A * b + 1.5 * a * (-B - Δ ** 0.5);
            let m = root(y, 3) + root(z, 3);
            let n = root(y, 3) - root(z, 3);
            let p = (-b + 0.5 * m) / (3 * a);
            let q = (3 ** 0.5 * n) / (6 * a);
            return [(-b - m) / (3 * a), [p, q], [p, -q]];
        }
        else {
            let θ = Math.acos(b / A ** 0.5 - 3 * a * B / (2 * A ** 1.5)) / 3;
            let m = Math.sin(θ);
            let n = Math.cos(θ);
            let p = A ** 0.5;
            return [-b - 2 * p * n, -b + p * (n + 3 ** 0.5 * m), -b + p * (n - 3 ** 0.5 * m)].map(item => item / (3 * a));
        }
    }
    solveQuartic(a, b, c, d, e) { // Shen Tianheng's formula
        var D = 3 * b ** 2 - 8 * a * c;
        var E = -(b ** 3) + 4 * a * b * c - 8 * a ** 2 * d;
        var F = 3 * b ** 4 + 16 * a ** 2 * c ** 2 - 16 * a * b ** 2 * c + 16 * a ** 2 * b * d - 64 * a ** 3 * e;
        var A = D ** 2 - 3 * F;
        var B = D * F - 9 * E ** 2;
        var C = F ** 2 - 3 * D * E ** 2;
        var Δ = B ** 2 - 4 * A * C;
        if (D === 0 && E === 0 && F === 0) {
            let x = -b / (4 * a);
            return [x, x, x, x];
        }
        else if (D !== 0 && E !== 0 && F !== 0 && A === 0 && B === 0 && C === 0) {
            let m = -b / (4 * a);
            let n = (3 * E) / (4 * a * D);
            let x = m - n;
            return [m + 3 * n, x, x, x];
        }
        else if (D !== 0 && E === 0 && F === 0) {
            let m = -b / (4 * a);
            let n = Math.abs(D) ** 0.5 / (4 * a);
            return D >= 0 ? [m + n, m + n, m - n, m - n] : [[m, n], [m, n], [m, -n], [m, -n]];
        }
        else if (A !== 0 && B !== 0 && C !== 0 && Δ === 0) {
            let m = 2 * A * E / B;
            let n = 2 * B / A;
            let p = (m - b) / (4 * a);
            let q = Math.abs(n) ** 0.5 / (4 * a);
            let x = (-b - m) / (4 * a);
            return n >= 0 ? [p + q, p - q, x, x] : [[p, q], [p, -q], x, x];
        }
        else if (Δ > 0) {
            let root = (a, b) => a >= 0 ? a ** (1 / b) : -((-a) ** (1 / b));
            let z_1 = A * D + 1.5 * (-B + Δ ** 0.5);
            let z_2 = A * D + 1.5 * (-B - Δ ** 0.5);
            let m = root(z_1, 3) + root(z_2, 3);
            let z = D ** 2 - D * m + m ** 2 - 3 * A;
            let n = E > 0 ? 1 : E < 0 ? -1 : 0;
            let p = (-b + n * ((D + m) / 3) ** 0.5) / (4 * a);
            let q = ((2 * D - m + 2 * z ** 0.5) / 3) ** 0.5 / (4 * a);
            let r = (-b - n * ((D + m) / 3) ** 0.5) / (4 * a);
            let s = ((-2 * D + m + 2 * z ** 0.5) / 3) ** 0.5 / (4 * a);
            return [p + q, p - q, [r, s], [r, -s]];
        }
        else {
            let θ = Math.acos((3 * B) / (2 * A ** 1.5) - D / A ** 0.5) / 3;
            let y_1 = (D - 2 * A ** 0.5 * Math.cos(θ)) / 3;
            let y_2 = (D + A ** 0.5 * (Math.cos(θ) + 3 ** 0.5 * Math.sin(θ))) / 3;
            let y_3 = (D + A ** 0.5 * (Math.cos(θ) - 3 ** 0.5 * Math.sin(θ))) / 3;
            let m = -b / (4 * a);
            if (E === 0) {
                if (F > 0) {
                    let n = (Math.abs(D) + 2 * F ** 0.5) ** 0.5 / (4 * a);
                    let p = (Math.abs(D) - 2 * F ** 0.5) ** 0.5 / (4 * a);
                    return D > 0 ? [m + n, m - n, m + p, m - p] : [[m, n], [m, -n], [m, p], [m, -p]];
                }
                else {
                    let n = (2 * (D + (A - F) ** 0.5)) ** 0.5 / (8 * a);
                    let p = (2 * (-D + (A - F) ** 0.5)) ** 0.5 / (8 * a);
                    return [[m + n, p], [m + n, -p], [m - n, p], [m - n, -p]];
                }
            }
            else {
                let k = E > 0 ? 1 : E < 0 ? -1 : 0;
                if (D > 0 && F > 0) {
                    let n = k * y_1 ** 0.5 / (4 * a);
                    let p = (y_2 ** 0.5 + y_3 ** 0.5) / (4 * a);
                    let q = (y_2 ** 0.5 - y_3 ** 0.5) / (4 * a);
                    return [m + n + p, m + n - p, m - n + q, m - n - q];
                }
                else {
                    let n = y_2 ** 0.5 / (4 * a);
                    let p = (k * (-y_1) ** 0.5 + (-y_3) ** 0.5) / (4 * a);
                    let q = (k * (-y_1) ** 0.5 - (-y_3) ** 0.5) / (4 * a);
                    return [[m - n, p], [m - n, -p], [m + n, q], [m + n, -q]];
                }
            }
        }
    }
}

class LinearEquation {
    constructor() {
        var button = document.querySelector("#linear-equation input");
        var input = document.querySelector("#linear-equation textarea");
        var output = document.querySelectorAll("#linear-equation textarea")[1];
        button.onclick = () => {
            if (input.value === "") {
                return;
            }
            try {
                var params = input.value.split("\n").filter(a => a).map(item => item.split(" ").filter(a => a).map(Number));
                var result = this.solve(params);
                if (result === null) {
                    output.value = "无解";
                }
                else if (result === undefined) {
                    output.value = "有无数个解";
                }
                else {
                    output.value = result.map((item, i) => `x_${i + 1} = ${item}`).join("\n");
                }
            }
            catch {
                alert("参数错误");
            }
        };
    }
    det(det) { // calculate determinants
        if (!det.every(item => item.length === det.length)) {
            throw RangeError;
        }
        var n = det.length;
        switch (n) {
            case 1 :
                return det[0][0];
            case 2 :
                return det[0][0] * det[1][1] - det[0][1] * det[1][0];
            case 3 :
                return det[0][0] * det[1][1] * det[2][2] - det[0][0] * det[1][2] * det[2][1] - det[0][1] * det[1][0] * det[2][2] + det[0][1] * det[1][2] * det[2][0] + det[0][2] * det[1][0] * det[2][1] - det[0][2] * det[1][1] * det[2][0];
        }
        var result = 0;
        for (let col = 0; col < n; col++) {
            let matrix = new Array(n - 1).fill(0).map(() => new Array(n - 1).fill(0));
            for (let i = 0; i < n - 1; i++) {
                for (let j = 0; j < n - 1; j++) {
                    matrix[i][j] = det[i + 1][j < col ? j : j + 1];
                }
            }
            result += (-1) ** (col % 2) * det[0][col] * this.det(matrix);
        }
        return result;
    }
    cutOut(array, n) { // cut out column n of array
        return array.map(item => item.filter((item, i) => i !== n));
    }
    solve(a) {
        if (!a.every(item => item.every(item => !isNaN(item)) && item.length === a.length + 1)) {
            throw TypeError;
        }
        var p = a.map((item, i) => ((-1) ** (a.length + i)) * this.det(this.cutOut(a, i)));
        var q = this.det(this.cutOut(a, a.length));
        if (q === 0) {
            return p[0] ? null : undefined; // null: no solution, undefined: infinite solutions
        }
        else {
            return p.map(item => item / q);
        }
    }
}

window.onload = () => {
    var factorization = new Factorization();
    var baseConversion = new BaseConversion();
    var monadicEquation = new MonadicEquation();
    var linearEquation = new LinearEquation();
};
        </script>
    </head>
    <body>
        <section id="factorization">
            <header>分解质因数</header>
            <p>
                <input type="text" value="" style="width: 50%; text-align: right;" />
                <input type="button" value="分解" />
                &nbsp; <span style="display: none;"></span>
            </p>
            <p><input type="text" readonly value="" /></p>
        </section>
        <section id="base-conversion">
            <header>进制转换</header>
            <p>
                <input class="base" type="number" min="2" max="256" step="1" value="10" /> 进制 &nbsp; &nbsp;
                <input class="number" type="text" value="0" /> &nbsp; &nbsp;
                序列：<input class="sequence" type="text" maxlength="256" value="0123456789" />
            </p>
            <p>转为 &nbsp; <input id="swap" type="button" value="&uarr;&darr;" /></p>
            <p>
                <input class="base" type="number" min="2" max="256" step="1" value="16" /> 进制 &nbsp; &nbsp;
                <input class="number" type="text" value="0" readonly /> &nbsp; &nbsp;
                序列：<input class="sequence" type="text" maxlength="256" value="0123456789ABCDEF" />
            </p>
            <p class="error" style="color: #FF0000;"></p>
        </section>
        <section id="monadic-equation">
            <header>解一元n次方程</header>
            <img src="https://www.zhihu.com/equation?tex=a_1x%5En%2Ba_2x%5E%7Bn-1%7D%2B%5Ccdots%2Ba_%7Bn-1%7Dx%5E2%2Ba_nx%2Ba_%7Bn%2B1%7D%3D0%5Cspace(n%5Cin%5Cleft%5C%7B1%2C2%2C3%2C4%5Cright%5C%7D)" />
            <p>请输入方程一般形式的各参数，以空格分隔。 <input type="button" value="确定" /></p>
            <input type="text" placeholder="示例：8 0 -6 1" value="" />
            <textarea readonly></textarea>
        </section>
        <section id="linear-equation">
            <header>解n元一次方程组</header>
            <img src="https://www.zhihu.com/equation?tex=a_1x_1%2Ba_2x_2%2B%5Ccdots%2Ba_%7Bn-1%7Dx_%7Bn-1%7D%2Ba_nx_n%2Ba_%7Bn%2B1%7D%3D0%5Cspace(n%5Cin%5Cmathbb%7BN%7D_%2B)" />
            <p>请输入方程一般形式的各参数，方程间以换行分隔，参数间以空格分隔。 <input type="button" value="确定" /></p>
            <textarea placeholder="示例：&#10;1 1 1 -6&#10;1 2 3 -14&#10;1 -1 1 -2"></textarea>
            <textarea readonly></textarea>
        </section>
    </body>
</html>